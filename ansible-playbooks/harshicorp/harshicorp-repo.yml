---
- name: Install harshircorp repo
  hosts: all
  become: yes

  vars:
    base_url: "https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo"
    gpgkey: "https://rpm.releases.hashicorp.com/gpg"
    terraform_version: "terraform-1.7.3"

  tasks:

    - name: Read playbook version and description from file
          slurp:
            src: playbook_version.txt
          register: version_file

        - name: Decode and parse the playbook version file
          set_fact:
            playbook_metadata: "{{ version_file.content | b64decode | from_yaml }}"

        - name: Display the playbook version and description
          debug:
            msg: "Running playbook version: {{ playbook_metadata.version }} - {{ playbook_metadata.description }}"

    - name: Add harshicorp repo using yum repository
      yum_repository:
        name: hashicorp
        description: "HashiCorp Stable - $basearch"
        baseurl: {{ base_url }}
        gpgkey: {{ gpgkey }}
        enabled: yes
        state: present

    - name: Install a specific version of terraform
      yum:
        name: {{ terraform_version }}
        state: present

    - name: Verify terraform version
      command: terraform --version
      register: terraform_version_output

    - name: Display Terraform version
      debug:
        msg: "{{terraform_version_output}}"